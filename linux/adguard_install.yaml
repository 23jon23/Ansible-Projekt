---
- name: "Konfiguracja serwera AGH_Lebda pod AdGuard Home (LVM-RAID1)"
  hosts: linux
  become: true

  vars:
    raid_devices: "/dev/sdb,/dev/sdc"
    vg_name: "adg_vg"
    lv_name: "adg_lv"
    mount_path: "/adguardhome"
    
    allowed_ports:
      - "22/tcp"    
      - "53/udp"     
      - "53/tcp"  
      - "80/tcp"    
      - "3000/tcp"  
      - "443/tcp"   

  tasks:
    - name: "Instalacja narzędzi dyskowych (lvm2)"
      apt:
        name: lvm2
        state: present
        update_cache: yes

    - name: "Tworzenie Grupy Woluminów (VG) - {{ vg_name }}"
      lvg:
        vg: "{{ vg_name }}"
        pvs: "{{ raid_devices }}"

    - name: "Sprawdzenie czy wolumin logiczny już istnieje"
      shell: "lvs /dev/{{ vg_name }}/{{ lv_name }}"
      register: lv_exists
      ignore_errors: yes
      changed_when: false

    - name: "Tworzenie Woluminu Logicznego (LV) w logice RAID1"
      lvol:
        vg: "{{ vg_name }}"
        lv: "{{ lv_name }}"
        size: 100%VG
        opts: "--type raid1"
      when: lv_exists.rc != 0  

    - name: "Formatowanie woluminu systemem plików EXT4"
      filesystem:
        fstype: ext4
        dev: "/dev/{{ vg_name }}/{{ lv_name }}"

    - name: "Tworzenie punktu montowania i montowanie woluminu"
      mount:
        path: "{{ mount_path }}"
        src: "/dev/{{ vg_name }}/{{ lv_name }}"
        fstype: ext4
        opts: "defaults,exec" 
        state: mounted

    - name: "Pobieranie i rozpakowywanie AdGuard Home"
      unarchive:
        src: "https://static.adguard.com/adguardhome/release/AdGuardHome_linux_amd64.tar.gz"
        dest: "{{ mount_path }}"
        remote_src: yes
        extra_opts: [--strip-components=1]

    - name: "Nadanie uprawnień wykonywania dla pliku binarnego"
      file:
        path: "{{ mount_path }}/AdGuardHome"
        mode: '0755'
        owner: root
        group: root

    - name: "Instalacja AdGuard Home jako usługi systemowej"
      shell: "./AdGuardHome -s install"
      args:
        chdir: "{{ mount_path }}"
        creates: "/etc/systemd/system/AdGuardHome.service"

    - name: "Instalacja oprogramowania zapory ogniowej (UFW)"
      apt:
        name: ufw
        state: present

    - name: "Konfiguracja polityki UFW: blokada ruchu przychodzącego"
      ufw:
        state: enabled
        policy: deny
        direction: incoming

    - name: "Otwieranie portów dla SSH i AdGuard Home"
      ufw:
        rule: allow
        port: "{{ item | split('/') | first }}"
        proto: "{{ item | split('/') | last }}"
      loop: "{{ allowed_ports }}"

    - name: "Sprawdzenie czy dziala autostart dla UFW"
      service:
        name: ufw
        enabled: yes
        state: started
